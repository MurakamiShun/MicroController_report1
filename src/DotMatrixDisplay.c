#include <xc.h> // include processor files - each processor file is guarded.  
#include <stdbool.h>
#include <stdint.h>
#include <stdlib.h>
#include "DotMatrixDisplay.h"
#include "IntervalTimerForDMD.h"

#define _NUMBER_PATTERN_OFFSET   (0x1C)

typedef struct{
    uint8_t _column[8];
} Pattern;

static const Pattern _PATTERN[] = {
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // 全消灯
    {0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF}, // ┓形
    {0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0}, // ┏形
    {0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0xFF, 0xFF}, // ┛形
    {0xFF, 0xFF, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03}, // ┗形
    {0xFF, 0xFF, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18}, // ┣形
    {0xC0, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xC0}, // ┳形
    {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xFF, 0xFF}, // ┫形
    {0x03, 0x03, 0x03, 0xFF, 0xFF, 0x03, 0x03, 0x03}, // ┻形
    {0x18, 0x18, 0x18, 0xFF, 0xFF, 0x18, 0x18, 0x18}, // ╋形
    {0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF}, // 四角形
    {0x18, 0x3C, 0x66, 0xC3, 0xC3, 0x66, 0x3C, 0x18}, // ひし形
    {0x42, 0xE7, 0x7E, 0x3C, 0x3C, 0x7E, 0xE7, 0x42}, // ×
    {0xE0, 0xFC, 0x1E, 0x07, 0x07, 0x1E, 0xFC, 0xE0}, // V字
    {0x01, 0x0F, 0x79, 0x81, 0x81, 0x79, 0x0F, 0x01}, // 上向き三角
    {0xFF, 0x42, 0x42, 0x42, 0x24, 0x24, 0x24, 0x18}, // 右向き三角
    {0x80, 0xF0, 0x8E, 0x81, 0x81, 0x8E, 0xF0, 0x80}, // 下向き三角
    {0x18, 0x24, 0x24, 0x24, 0x42, 0x42, 0x42, 0xFF}, // 左向き三角
    {0x00, 0x00, 0x18, 0x3C, 0x3C, 0x18, 0x00, 0x00}, // ・
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}, // 全点灯
    {0x18, 0x30, 0x60, 0xFF, 0xFF, 0x60, 0x30, 0x18}, // 上向き矢印
    {0x02, 0x87, 0x8E, 0x9C, 0xB8, 0xF0, 0xE0, 0xFE}, // 右上向き矢印
    {0x18, 0x18, 0x18, 0x99, 0xDB, 0x7E, 0x3C, 0x18}, // 右向き矢印
    {0x40, 0xE1, 0x71, 0x39, 0x1D, 0x0F, 0x07, 0x7F}, // 右下向き矢印
    {0x18, 0x0C, 0x06, 0xFF, 0xFF, 0x06, 0x0C, 0x18}, // 下向き矢印
    {0x7F, 0x07, 0x0F, 0x1D, 0x39, 0x71, 0xE1, 0x40}, // 左下向き矢印
    {0x18, 0x3C, 0x7E, 0xDB, 0x99, 0x18, 0x18, 0x18}, // 左向き矢印
    {0xFE, 0xE0, 0xF0, 0xB8, 0x9C, 0x8E, 0x87, 0x02}, // 左上向き矢印
    {0x00, 0x7E, 0xE7, 0x81, 0x81, 0xE7, 0x7E, 0x00}, // 0
    {0x00, 0x21, 0x61, 0xFF, 0xFF, 0x01, 0x01, 0x00}, // 1
    {0x00, 0x61, 0xC3, 0x87, 0x8D, 0xD9, 0x71, 0x00}, // 2
    {0x00, 0x46, 0xD3, 0x91, 0x91, 0xDA, 0x6E, 0x00}, // 3
    {0x0C, 0x3C, 0x64, 0xC4, 0xFF, 0xFF, 0x04, 0x00}, // 4
    {0x00, 0xFA, 0xFB, 0x91, 0x91, 0x9B, 0x8E, 0x00}, // 5
    {0x00, 0x7E, 0xFF, 0x91, 0x91, 0xDB, 0x4E, 0x00}, // 6
    {0x00, 0xF0, 0xF0, 0x80, 0x80, 0xFF, 0xFF, 0x00}, // 7
    {0x00, 0x6E, 0xBB, 0x91, 0x91, 0xBB, 0x6E, 0x00}, // 8
    {0x00, 0x70, 0xD8, 0x88, 0xD8, 0xFF, 0x7F, 0x00}, // 9
    {0x41, 0xFF, 0x01, 0x00, 0x7E, 0xC3, 0x7E, 0x00}, // 10
    {0x41, 0xFF, 0x01, 0x00, 0x41, 0xFF, 0x01, 0x00}, // 11
    {0x41, 0xFF, 0x01, 0x00, 0x61, 0x83, 0x7D, 0x00}, // 12
    {0x41, 0xFF, 0x01, 0x00, 0x52, 0x91, 0x6E, 0x00}, // 13
    {0x41, 0xFF, 0x01, 0x00, 0x3C, 0x44, 0xFF, 0x00}, // 14
    {0x41, 0xFF, 0x01, 0x00, 0xF2, 0x91, 0x9E, 0x00}, // 15
    {0x41, 0xFF, 0x01, 0x00, 0x7E, 0x91, 0x4E, 0x00}, // 16
    {0x41, 0xFF, 0x01, 0x00, 0xE0, 0x87, 0xF8, 0x00}, // 17
    {0x41, 0xFF, 0x01, 0x00, 0x6E, 0x91, 0x6E, 0x00}, // 18
    {0x41, 0xFF, 0x01, 0x00, 0x62, 0x91, 0x7F, 0x00}, // 19
    {0x61, 0x83, 0x7D, 0x00, 0x7E, 0xC3, 0x7E, 0x00}, // 20
    {0x61, 0x83, 0x7D, 0x00, 0x41, 0xFF, 0x01, 0x00}, // 21
    {0x61, 0x83, 0x7D, 0x00, 0x61, 0x83, 0x7D, 0x00}, // 22
    {0x61, 0x83, 0x7D, 0x00, 0x52, 0x91, 0x6E, 0x00}, // 23
    {0x61, 0x83, 0x7D, 0x00, 0x3C, 0x44, 0xFF, 0x00}, // 24
    {0x61, 0x83, 0x7D, 0x00, 0xF2, 0x91, 0x9E, 0x00}, // 25
    {0x61, 0x83, 0x7D, 0x00, 0x7E, 0x91, 0x4E, 0x00}, // 26
    {0x61, 0x83, 0x7D, 0x00, 0xE0, 0x87, 0xF8, 0x00}, // 27
    {0x61, 0x83, 0x7D, 0x00, 0x6E, 0x91, 0x6E, 0x00}, // 28
    {0x61, 0x83, 0x7D, 0x00, 0x62, 0x91, 0x7F, 0x00}, // 29
    {0x52, 0x91, 0x6E, 0x00, 0x7E, 0xC3, 0x7E, 0x00}, // 30
    {0x52, 0x91, 0x6E, 0x00, 0x41, 0xFF, 0x01, 0x00}, // 31
    {0x52, 0x91, 0x6E, 0x00, 0x61, 0x83, 0x7D, 0x00}, // 32
    {0x52, 0x91, 0x6E, 0x00, 0x52, 0x91, 0x6E, 0x00}, // 33
    {0x52, 0x91, 0x6E, 0x00, 0x3C, 0x44, 0xFF, 0x00}, // 34
    {0x52, 0x91, 0x6E, 0x00, 0xF2, 0x91, 0x9E, 0x00}, // 35
    {0x52, 0x91, 0x6E, 0x00, 0x7E, 0x91, 0x4E, 0x00}, // 36
    {0x52, 0x91, 0x6E, 0x00, 0xE0, 0x87, 0xF8, 0x00}, // 37
    {0x52, 0x91, 0x6E, 0x00, 0x6E, 0x91, 0x6E, 0x00}, // 38
    {0x52, 0x91, 0x6E, 0x00, 0x62, 0x91, 0x7F, 0x00}, // 39
    {0x3C, 0x44, 0xFF, 0x00, 0x7E, 0xC3, 0x7E, 0x00}, // 40
    {0x3C, 0x44, 0xFF, 0x00, 0x41, 0xFF, 0x01, 0x00}, // 41
    {0x3C, 0x44, 0xFF, 0x00, 0x61, 0x83, 0x7D, 0x00}, // 42
    {0x3C, 0x44, 0xFF, 0x00, 0x52, 0x91, 0x6E, 0x00}, // 43
    {0x3C, 0x44, 0xFF, 0x00, 0x3C, 0x44, 0xFF, 0x00}, // 44
    {0x3C, 0x44, 0xFF, 0x00, 0xF2, 0x91, 0x9E, 0x00}, // 45
    {0x3C, 0x44, 0xFF, 0x00, 0x7E, 0x91, 0x4E, 0x00}, // 46
    {0x3C, 0x44, 0xFF, 0x00, 0xE0, 0x87, 0xF8, 0x00}, // 47
    {0x3C, 0x44, 0xFF, 0x00, 0x6E, 0x91, 0x6E, 0x00}, // 48
    {0x3C, 0x44, 0xFF, 0x00, 0x62, 0x91, 0x7F, 0x00}, // 49
    {0xF2, 0x91, 0x9E, 0x00, 0x7E, 0xC3, 0x7E, 0x00}, // 50
    {0xF2, 0x91, 0x9E, 0x00, 0x41, 0xFF, 0x01, 0x00}, // 51
    {0xF2, 0x91, 0x9E, 0x00, 0x61, 0x83, 0x7D, 0x00}, // 52
    {0xF2, 0x91, 0x9E, 0x00, 0x52, 0x91, 0x6E, 0x00}, // 53
    {0xF2, 0x91, 0x9E, 0x00, 0x3C, 0x44, 0xFF, 0x00}, // 54
    {0xF2, 0x91, 0x9E, 0x00, 0xF2, 0x91, 0x9E, 0x00}, // 55
    {0xF2, 0x91, 0x9E, 0x00, 0x7E, 0x91, 0x4E, 0x00}, // 56
    {0xF2, 0x91, 0x9E, 0x00, 0xE0, 0x87, 0xF8, 0x00}, // 57
    {0xF2, 0x91, 0x9E, 0x00, 0x6E, 0x91, 0x6E, 0x00}, // 58
    {0xF2, 0x91, 0x9E, 0x00, 0x62, 0x91, 0x7F, 0x00}, // 59
    {0x7E, 0x91, 0x4E, 0x00, 0x7E, 0xC3, 0x7E, 0x00}, // 60
    {0x7E, 0x91, 0x4E, 0x00, 0x41, 0xFF, 0x01, 0x00}, // 61
    {0x7E, 0x91, 0x4E, 0x00, 0x61, 0x83, 0x7D, 0x00}, // 62
    {0x7E, 0x91, 0x4E, 0x00, 0x52, 0x91, 0x6E, 0x00}, // 63
    {0x7E, 0x91, 0x4E, 0x00, 0x3C, 0x44, 0xFF, 0x00}, // 64
    {0x7E, 0x91, 0x4E, 0x00, 0xF2, 0x91, 0x9E, 0x00}, // 65
    {0x7E, 0x91, 0x4E, 0x00, 0x7E, 0x91, 0x4E, 0x00}, // 66
    {0x7E, 0x91, 0x4E, 0x00, 0xE0, 0x87, 0xF8, 0x00}, // 67
    {0x7E, 0x91, 0x4E, 0x00, 0x6E, 0x91, 0x6E, 0x00}, // 68
    {0x7E, 0x91, 0x4E, 0x00, 0x62, 0x91, 0x7F, 0x00}, // 69
    {0xE0, 0x87, 0xF8, 0x00, 0x7E, 0xC3, 0x7E, 0x00}, // 70
    {0xE0, 0x87, 0xF8, 0x00, 0x41, 0xFF, 0x01, 0x00}, // 71
    {0xE0, 0x87, 0xF8, 0x00, 0x61, 0x83, 0x7D, 0x00}, // 72
    {0xE0, 0x87, 0xF8, 0x00, 0x52, 0x91, 0x6E, 0x00}, // 73
    {0xE0, 0x87, 0xF8, 0x00, 0x3C, 0x44, 0xFF, 0x00}, // 74
    {0xE0, 0x87, 0xF8, 0x00, 0xF2, 0x91, 0x9E, 0x00}, // 75
    {0xE0, 0x87, 0xF8, 0x00, 0x7E, 0x91, 0x4E, 0x00}, // 76
    {0xE0, 0x87, 0xF8, 0x00, 0xE0, 0x87, 0xF8, 0x00}, // 77
    {0xE0, 0x87, 0xF8, 0x00, 0x6E, 0x91, 0x6E, 0x00}, // 78
    {0xE0, 0x87, 0xF8, 0x00, 0x62, 0x91, 0x7F, 0x00}, // 79
    {0x6E, 0x91, 0x6E, 0x00, 0x7E, 0xC3, 0x7E, 0x00}, // 80
    {0x6E, 0x91, 0x6E, 0x00, 0x41, 0xFF, 0x01, 0x00}, // 81
    {0x6E, 0x91, 0x6E, 0x00, 0x61, 0x83, 0x7D, 0x00}, // 82
    {0x6E, 0x91, 0x6E, 0x00, 0x52, 0x91, 0x6E, 0x00}, // 83
    {0x6E, 0x91, 0x6E, 0x00, 0x3C, 0x44, 0xFF, 0x00}, // 84
    {0x6E, 0x91, 0x6E, 0x00, 0xF2, 0x91, 0x9E, 0x00}, // 85
    {0x6E, 0x91, 0x6E, 0x00, 0x7E, 0x91, 0x4E, 0x00}, // 86
    {0x6E, 0x91, 0x6E, 0x00, 0xE0, 0x87, 0xF8, 0x00}, // 87
    {0x6E, 0x91, 0x6E, 0x00, 0x6E, 0x91, 0x6E, 0x00}, // 88
    {0x6E, 0x91, 0x6E, 0x00, 0x62, 0x91, 0x7F, 0x00}, // 89
    {0x62, 0x91, 0x7F, 0x00, 0x7E, 0xC3, 0x7E, 0x00}, // 90
    {0x62, 0x91, 0x7F, 0x00, 0x41, 0xFF, 0x01, 0x00}, // 91
    {0x62, 0x91, 0x7F, 0x00, 0x61, 0x83, 0x7D, 0x00}, // 92
    {0x62, 0x91, 0x7F, 0x00, 0x52, 0x91, 0x6E, 0x00}, // 93
    {0x62, 0x91, 0x7F, 0x00, 0x3C, 0x44, 0xFF, 0x00}, // 94
    {0x62, 0x91, 0x7F, 0x00, 0xF2, 0x91, 0x9E, 0x00}, // 95
    {0x62, 0x91, 0x7F, 0x00, 0x7E, 0x91, 0x4E, 0x00}, // 96
    {0x62, 0x91, 0x7F, 0x00, 0xE0, 0x87, 0xF8, 0x00}, // 97
    {0x62, 0x91, 0x7F, 0x00, 0x6E, 0x91, 0x6E, 0x00}, // 98
    {0x62, 0x91, 0x7F, 0x00, 0x62, 0x91, 0x7F, 0x00}  // 99
};

static const Pattern *_displayPattern = NULL;

static uint8_t _contrast = 0; // contrast value [0-7]

static void _setColumnData(uint8_t column_data) {
    LATA6 = (column_data & 0x80) != 0; // ディスプレイ上方
    LATC0 = (column_data & 0x40) != 0;
    LATC1 = (column_data & 0x20) != 0;
    LATC2 = (column_data & 0x10) != 0;
    
    LATC5 = (column_data & 0x08) != 0;
    LATA7 = (column_data & 0x04) != 0;
    LATB1 = (column_data & 0x02) != 0;
    LATB2 = (column_data & 0x01) != 0; // ディスプレイ下方
}

static void _controlShiftRegister(uint8_t column) {
    // 0の時だけ1を入れる
    LATA4 = (column == 0);
    
    // シフトさせる
    LATA5 = 1;
    LATA5 = 0;
}

static void _clearColumn(void) {
    // 全消灯
    LATA6 = 0;
    LATC0 = 0;
    LATC1 = 0;
    LATC2 = 0;
    LATC5 = 0;
    LATA7 = 0;
    LATB1 = 0;
    LATB2 = 0;
}

static void _refresh(void){
    static uint8_t column = 0;
    static uint8_t conter_for_contrast = 0;
    
    _clearColumn(); // 前の残像が残るのを防止
    _controlShiftRegister(column); // パターン出力
    
    if((conter_for_contrast&7) > _contrast){    
        _setColumnData(_displayPattern->_column[column]);
    }
    ++column;
    if(column == 8){
        column = 0;
        conter_for_contrast++;
    }
}

void DotMatrixDisplay_initialize(void) {
    /*
     * 行ピンの設定
     */
    ANSB1 = 0; // PortB1をデジタルピンとする
    ANSB2 = 0; // PortB2をデジタルピンとする
    
    TRISA6 = 0; // PortA6を出力端子とする
    TRISC0 = 0; // PortC0を出力端子とする
    TRISC1 = 0; // PortC1を出力端子とする
    TRISC2 = 0; // PortC2を出力端子とする
    TRISC5 = 0; // PortC5を出力端子とする
    TRISA7 = 0; // PortA7を出力端子とする
    TRISB1 = 0; // PortB1を出力端子とする
    TRISB2 = 0; // PortB2を出力端子とする
    
    /*
     * 列ピンの設定
     */
    ANSA5  = 0; // PortA5をデジタルピンとする
    TRISA5 = 0; // PortA5を出力端子とする
    TRISA4 = 0; // PortA4を出力端子とする
    
    IntervalTimerForDMD_setCallback(_refresh);
    IntervalTimerForDMD_initialize(); // タイマ初期化
}

void DotMatrixDisplay_setPattern(ShapeType type) {
    _displayPattern = &_PATTERN[type];
}

void DotMatrixDisplay_setNumberPattern(uint8_t value) {
    _displayPattern = &_PATTERN[value + _NUMBER_PATTERN_OFFSET];
}

void DotMatrixDisplay_show(void){
    IntervalTimerForDMD_start();
}

void DotMatrixDisplay_hide(void){
    _clearColumn(); // 前の残像が残るのを防止
    IntervalTimerForDMD_stop();
}

void DotMatrixDisplay_setContrast(uint8_t value){
    _contrast = value;
}